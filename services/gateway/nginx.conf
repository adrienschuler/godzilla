worker_processes 1;

# Expose environment variables to Lua code
env REDIS_SERVICE_HOST;
env REDIS_SERVICE_PORT;
env REDIS_PASSWORD;

events {
    worker_connections 1024;
}

http {
    # Configure DNS resolver for Kubernetes service discovery
    resolver kube-dns.kube-system.svc.cluster.local;

    # Path for Lua modules
    lua_package_path "/usr/local/openresty/lualib/?.lua;;";
    # Code cache for Lua scripts
    lua_code_cache on;

    # Initialize the Gateway module for each worker
    init_worker_by_lua_block {
        require("gateway").init()
    }

    default_type application/json;

    log_format main_format escape=json '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"method":"$request_method",'
        '"uri":"$uri",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"user_agent":"$http_user_agent"'
    '}';

    access_log /dev/stdout main_format;

    # Rate limiting zone: 10 requests/seconds per IP for login
    limit_req_zone $binary_remote_addr zone=login:10m rate=10r/s;

    upstream accounts {
        server accounts-svc:8081;
    }

    upstream chat {
        server chat-svc:3000;
    }

    server {
        listen 80;

        # Return JSON for all nginx-generated errors
        error_page 400 401 403 404 405 408 413 429 500 502 503 504 @error_json;

        location @error_json {
            internal;
            content_by_lua_block {
                local messages = {
                    [400] = "Bad Request",
                    [401] = "Unauthorized",
                    [403] = "Forbidden",
                    [404] = "Not Found",
                    [405] = "Method Not Allowed",
                    [408] = "Request Timeout",
                    [413] = "Payload Too Large",
                    [429] = "Too Many Requests",
                    [500] = "Internal Server Error",
                    [502] = "Bad Gateway",
                    [503] = "Service Unavailable",
                    [504] = "Gateway Timeout",
                }
                local status = ngx.status
                local msg = messages[status] or "Error"
                ngx.header.content_type = "application/json"
                ngx.say(string.format('{"status":"error","code":%d,"message":"%s"}', status, msg))
            }
        }

        location /user/login {
            limit_req zone=login burst=3 nodelay;
            proxy_pass http://accounts;
        }

        location /user/logout {
            proxy_pass http://accounts;
        }

        location /user/register {
            proxy_pass http://accounts;
        }

        location = /healthz {
            content_by_lua_block {
                ngx.header.content_type = "application/json"
                ngx.say('{"status":"ok"}')
            }
        }

        location /socket.io/ {
            access_by_lua_block {
                require("gateway"):handle_auth()
            }

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;

            proxy_read_timeout 86400;
            proxy_send_timeout 86400;

            proxy_pass http://chat;
        }

        location / {
            return 404;
        }
    }
}
